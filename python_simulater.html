<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Python Runner</title>
  <style>
    :root { color-scheme: light; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; }
    header {
      display:flex; gap:12px; align-items:center; padding:12px 16px;
      border-bottom:1px solid #e5e7eb; position:sticky; top:0; background:#fff;
    }
    header .status { margin-left:auto; font-size:12px; color:#6b7280; }
    main { height: calc(100vh - 58px); display:grid; grid-template-columns: 1fr 1fr; }
    .pane { display:flex; flex-direction:column; min-width:0; }
    .pane h2 { margin:0; padding:10px 12px; font-size:13px; color:#374151; border-bottom:1px solid #e5e7eb; background:#f9fafb; }
    textarea, pre {
      flex:1; width:100%; border:0; margin:0; padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 13px; line-height: 1.5; outline:none;
    }
    textarea { resize:none; }
    pre { white-space: pre-wrap; word-break: break-word; background:#0b1020; color:#e5e7eb; }
    .actions { display:flex; gap:8px; }
    button {
      border:1px solid #e5e7eb; background:#fff; padding:8px 12px; border-radius:10px;
      cursor:pointer; font-weight:600;
    }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    @media (max-width: 900px){
      main { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <strong>Mini Python Runner</strong>
    <div class="actions">
      <button id="btnRun" class="primary" disabled>実行</button>
      <button id="btnClear" disabled>結果クリア</button>
      <button id="btnReset" disabled>サンプルに戻す</button>
    </div>
    <div class="status" id="status">Pyodide 読み込み中…</div>
  </header>

  <main>
    <section class="pane">
      <h2>Python（左：コード）</h2>
      <textarea id="code" spellcheck="false"></textarea>
    </section>
    <section class="pane">
      <h2>結果（右：stdout / stderr）</h2>
      <pre id="out"></pre>
    </section>
  </main>

  <script type="module">
    const statusEl = document.getElementById("status");
    const outEl = document.getElementById("out");
    const codeEl = document.getElementById("code");
    const btnRun = document.getElementById("btnRun");
    const btnClear = document.getElementById("btnClear");
    const btnReset = document.getElementById("btnReset");

    const SAMPLE = `# ここにPythonを書いて「実行」！
print("Hello, Python!") 

# 計算
total = sum(range(1, 11))
print("1..10 =", total)

# エラーも表示されます
# 0/0
`;

    function setEnabled(v){
      btnRun.disabled = !v;
      btnClear.disabled = !v;
      btnReset.disabled = !v;
    }

    function append(text){
      outEl.textContent += text;
      outEl.scrollTop = outEl.scrollHeight;
    }

    function clearOut(){
      outEl.textContent = "";
    }

    // 1) Pyodide 本体をCDNからロード
    import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.mjs";

    let pyodide;
    try {
      pyodide = await loadPyodide({
        stdout: (s) => append(s + "\n"),
        stderr: (s) => append(s + "\n"),
      });
      statusEl.textContent = "準備完了";
      setEnabled(true);
    } catch (e) {
      statusEl.textContent = "読み込み失敗";
      append(String(e));
    }

    // 2) 標準入力は簡易で塞ぎます（必要なら後で実装）
    if (pyodide) {
      pyodide.setStdin({ stdin: () => { throw new Error("input() は未対応です"); }});
    }

    // 3) 初期コード
    codeEl.value = SAMPLE;

    btnRun.addEventListener("click", async () => {
      clearOut();
      statusEl.textContent = "実行中…";
      btnRun.disabled = true;

      try {
        // Python側のprint等は stdout に流れる
        await pyodide.runPythonAsync(codeEl.value);
        statusEl.textContent = "完了";
      } catch (e) {
        // 例外はここにも来るので整形して表示
        append("\n[Exception]\n" + (e?.message ?? String(e)));
        statusEl.textContent = "エラー";
      } finally {
        btnRun.disabled = false;
      }
    });

    btnClear.addEventListener("click", clearOut);

    btnReset.addEventListener("click", () => {
      codeEl.value = SAMPLE;
      clearOut();
      statusEl.textContent = "準備完了";
    });

    // Ctrl+Enter で実行
    codeEl.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter" && !btnRun.disabled) {
        btnRun.click();
      }
    });
  </script>
</body>
</html>
