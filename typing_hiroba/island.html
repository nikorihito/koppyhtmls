<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è½ã¡ã‚‹ãªï¼ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®ã‚“ã³ã‚Šå³¶</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Meiryo",sans-serif;background:#0b1020;color:#eaf0ff}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{cursor:pointer;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:#eaf0ff;padding:10px 12px;border-radius:12px}
    input{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.25);color:#eaf0ff;outline:none}
    .chip{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);border-radius:999px;padding:8px 10px;font-size:13px}
    .hud{display:flex;gap:10px;flex-wrap:wrap}
    .prompt{font-size:20px;line-height:1.7;word-break:break-word}
    .done{color:#35d07f}
    .next{text-decoration:underline;text-decoration-color:#7c5cff;text-underline-offset:3px}
    .todo{opacity:.92}
    canvas{width:100%;height:320px;border-radius:12px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10);margin-top:10px}
    .small{font-size:12px;opacity:.8;line-height:1.6}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸï¸ è½ã¡ã‚‹ãªï¼ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®ã‚“ã³ã‚Šå³¶</h1>

  <div class="card">
    <div class="row">
      <label>åå‰ <input id="name" placeholder="ä¾‹ï¼škoppy" maxlength="16"></label>
      <button class="btn" id="btnStart">é–‹å§‹</button>
      <button class="btn" id="btnStop">åœæ­¢</button>
    </div>
    <div class="hud" style="margin-top:10px">
      <span class="chip">ğŸŒŠ <span id="sea">0</span>%</span>
      <span class="chip">ğŸ¯ <span id="acc">100.0</span>%</span>
      <span class="chip">â±ï¸ <span id="t">0.0</span>s</span>
      <span class="chip">âŒ <span id="miss">0</span></span>
      <span class="chip">âœ¨ ãƒãƒ¼ãƒŸã‚¹é€£ç¶š <span id="streak">0</span></span>
    </div>
    <div class="small" style="margin-top:10px">
      ãƒŸã‚¹ã™ã‚‹ã¨æµ·é¢ä¸Šæ˜‡ã€‚ãƒãƒ¼ãƒŸã‚¹ãŒç¶šãã¨å°‘ã—ä¸‹ãŒã‚Šã¾ã™ã€‚ç„¦ã‚‰ãšã€æ­£ç¢ºã«ã€‚
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="prompt" id="prompt"></div>
    <div class="row" style="margin-top:10px">
      <input id="inp" placeholder="ã“ã“ã«å…¥åŠ›ï¼ˆ1æ–‡å­—ãšã¤åˆ¤å®šï¼‰" style="flex:1 1 340px">
    </div>
    <canvas id="cv" width="980" height="320"></canvas>
  </div>
</div>

<script type="module">
  const V = "11.0.0";
  import { initializeApp } from `https://www.gstatic.com/firebasejs/${V}/firebase-app.js`;
  import { getAuth, signInAnonymously } from `https://www.gstatic.com/firebasejs/${V}/firebase-auth.js`;
  import { getFirestore, doc, setDoc, serverTimestamp } from `https://www.gstatic.com/firebasejs/${V}/firebase-firestore.js`;

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    appId: "YOUR_APP_ID",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const u = await signInAnonymously(auth);
  const uid = u.user.uid;

  const ui = {
    name: document.getElementById("name"),
    btnStart: document.getElementById("btnStart"),
    btnStop: document.getElementById("btnStop"),
    sea: document.getElementById("sea"),
    acc: document.getElementById("acc"),
    t: document.getElementById("t"),
    miss: document.getElementById("miss"),
    streak: document.getElementById("streak"),
    prompt: document.getElementById("prompt"),
    inp: document.getElementById("inp"),
    cv: document.getElementById("cv"),
  };
  const ctx = ui.cv.getContext("2d");

  const SENTENCES = [
    "ã¿ã™ã‚’ã—ãªã„ã‚ˆã†ã« ã¦ã„ã­ã„ã« ã†ã¨ã†",
    "ã‚ã›ã‚‰ãš ã‚†ã£ãã‚Šã§ã„ã„ ãŸã ã—ãã†ã¨ã†",
    "ãŸã ã—ã ã†ã¦ã‚‹ã¨ ã‹ãªã‚‰ãš ã†ã¾ããªã‚‹",
    "ãã‚‡ã†ã‚‚ ã™ã“ã—ã ã‘ ã˜ã¶ã‚“ã‚’ ã“ãˆã‚‹"
  ];
  function pick(){ return SENTENCES[Math.floor(Math.random()*SENTENCES.length)]; }
  function esc(s){return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");}

  const state = {
    running:false,
    startMs:0,
    text:"",
    i:0,
    total:0, correct:0, miss:0,
    sea:0,        // 0..100
    streak:0,
    loop:null
  };

  function renderPrompt(){
    const t = state.text, i = state.i;
    const done=t.slice(0,i), next=t[i]??"", todo=t.slice(i+1);
    ui.prompt.innerHTML = `<span class="done">${esc(done)}</span>${next?`<span class="next">${esc(next)}</span>`:""}<span class="todo">${esc(todo)}</span>`;
  }
  function metrics(){
    const elapsed = Math.max(1, performance.now()-state.startMs);
    const acc = state.total ? (state.correct/state.total)*100 : 100;
    return { elapsed, acc };
  }
  function draw(){
    const W=ui.cv.width,H=ui.cv.height;
    ctx.clearRect(0,0,W,H);

    // sky
    ctx.fillStyle="rgba(255,255,255,.04)";
    ctx.fillRect(0,0,W,H);

    // sea
    const seaH = (state.sea/100) * H;
    ctx.fillStyle="rgba(70,140,255,.30)";
    ctx.fillRect(0,H-seaH,W,seaH);

    // island platform
    ctx.fillStyle="rgba(255,230,160,.45)";
    ctx.beginPath();
    ctx.ellipse(W*0.55, H*0.62, 180, 60, 0, 0, Math.PI*2);
    ctx.fill();

    // player
    ctx.font="28px system-ui";
    ctx.fillText("ğŸ™‚", W*0.52, H*0.60);

    // sea percent
    ctx.font="14px ui-monospace, monospace";
    ctx.fillStyle="rgba(234,240,255,.9)";
    ctx.fillText(`SEA ${Math.round(state.sea)}%`, 14, 24);
  }

  function tick(){
    if(!state.running) return;
    const { elapsed, acc } = metrics();
    ui.t.textContent = (elapsed/1000).toFixed(1);
    ui.acc.textContent = acc.toFixed(1);
    ui.sea.textContent = String(Math.round(state.sea));
    ui.miss.textContent = String(state.miss);
    ui.streak.textContent = String(state.streak);

    // ãƒãƒ¼ãƒŸã‚¹æ•‘æ¸ˆï¼šä¸€å®šé€£ç¶šã§æµ·é¢å¾®æ¸›
    if(state.streak > 0 && state.streak % 12 === 0){
      state.sea = Math.max(0, state.sea - 2);
    }

    if(state.sea >= 100){
      stop(true);
      return;
    }

    draw();
    requestAnimationFrame(tick);
  }

  function start(){
    state.running = true;
    state.startMs = performance.now();
    state.text = pick();
    state.i=0;
    state.total=0; state.correct=0; state.miss=0;
    state.sea=0;
    state.streak=0;
    ui.inp.value="";
    ui.inp.focus();
    renderPrompt();
    requestAnimationFrame(tick);
  }

  async function stop(gameOver){
    state.running=false;
    const { elapsed, acc } = metrics();
    // ä¿å­˜ï¼šscore=ç”Ÿå­˜ç§’ã€acc=Accuracy
    await saveScore("island", { acc, timeMs: Math.round(elapsed) });
    alert(gameOver ? `è½ä¸‹â€¦ ç”Ÿå­˜ ${(elapsed/1000).toFixed(1)}s` : "åœæ­¢ã—ã¾ã—ãŸï¼ˆè¨˜éŒ²ä¿å­˜ï¼‰");
  }

  async function saveScore(mode, { acc, timeMs }){
    const name = (ui.name.value || "Guest").trim().slice(0,16) || "Guest";
    const ref = doc(db, "leaderboards", mode, "scores", uid);
    await setDoc(ref, {
      name,
      acc,
      score: Math.round(timeMs/1000), // ç”Ÿå­˜ç§’
      timeMs,
      updatedAt: serverTimestamp()
    }, { merge:true });
  }

  ui.inp.addEventListener("keydown",(e)=>{
    if(!state.running) return;
    if(e.key.length===1 && !e.ctrlKey && !e.metaKey && !e.altKey){
      e.preventDefault();
      const expected = state.text[state.i];
      if(expected==null) return;
      state.total++;
      if(e.key===expected){
        state.correct++;
        state.i++;
        state.streak++;
        renderPrompt();
        if(state.i>=state.text.length){
          // 1æ–‡æ‰“ã¡åˆ‡ã‚Šã§æ¬¡ã¸ï¼ˆæµ·é¢å°‘ã—å›å¾©ï¼‰
          state.sea = Math.max(0, state.sea - 5);
          state.text = pick();
          state.i = 0;
          renderPrompt();
        }
      }else{
        state.miss++;
        state.streak = 0;
        // æµ·é¢ä¸Šæ˜‡ï¼ˆæ­£ç¢ºæ€§ãƒ¢ãƒ¼ãƒ‰ï¼‰
        state.sea = Math.min(100, state.sea + 6);
      }
    }
  });

  ui.btnStart.addEventListener("click", start);
  ui.btnStop.addEventListener("click", ()=> stop(false));

  ui.prompt.textContent="ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
  draw();
</script>
</body>
</html>
