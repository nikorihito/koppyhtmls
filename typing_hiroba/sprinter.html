<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç›®æŒ‡ã›ï¼ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¹ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ï¼ˆã‚½ãƒ­ï¼‰</title>
  <meta name="description" content="çŸ­è·é›¢å‹ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ¬ãƒ¼ã‚¹ã€‚WPMã¨Accuracyã§è‡ªå·±ãƒ™ã‚¹ãƒˆæ›´æ–°ã‚’ç‹™ã†ã€‚" />
  <style>
    :root{
      --bg:#f6f8ff;
      --card: rgba(255,255,255,.82);
      --card2: rgba(255,255,255,.65);
      --text:#101425;
      --muted:#5e6a86;
      --line: rgba(16,20,37,.12);
      --accent:#4f7cff;
      --accent2:#33c2a1;
      --bad:#ff4d6d;
      --warn:#ffb020;
      --shadow: 0 18px 55px rgba(25,35,70,.12);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background: var(--bg);
    }

    /* èƒŒæ™¯ç”»åƒ */
    .bg{
      position:fixed; inset:0;
      background:
        linear-gradient(180deg, rgba(246,248,255,.92), rgba(246,248,255,.72)),
        url("./sprinter_bg.png") center/cover no-repeat;
      filter:saturate(1.05);
      z-index:-1;
    }

    .wrap{max-width:1080px; margin:0 auto; padding:22px 16px 54px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      background: rgba(255,255,255,.75);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      position:sticky; top:12px; z-index:10;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px; height:44px; border-radius:16px;
      background: linear-gradient(135deg, rgba(79,124,255,.95), rgba(51,194,161,.75));
      box-shadow: 0 14px 40px rgba(79,124,255,.25);
    }
    h1{margin:0; font-size:16px; letter-spacing:.02em}
    .sub{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .top{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      transition:.15s ease;
    }
    .chip:hover{transform: translateY(-1px)}
    .chip .v{font-weight:700}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; margin-top:14px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .pad{padding:16px}

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .stat{
      flex: 1 1 160px;
      border:1px solid var(--line);
      border-radius:16px;
      background: var(--card2);
      padding:10px 12px;
    }
    .label{font-size:11px; color:var(--muted)}
    .value{margin-top:4px; font-weight:800; font-size:16px}

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.85);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{
      border-color: rgba(79,124,255,.35);
      background: linear-gradient(135deg, rgba(79,124,255,.20), rgba(255,255,255,.85));
    }

    .typingBox{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.90);
      padding:14px;
    }
    .jp{font-size:18px; font-weight:800; line-height:1.55}
    .kana{margin-top:6px; font-size:13px; color:var(--muted); line-height:1.55}
    .hint{margin-top:10px; font-size:12px; color:var(--muted)}
    .inputRow{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap}
    input[type="text"]{
      flex: 1 1 260px;
      border:1px solid var(--line);
      border-radius: 14px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
      background: rgba(255,255,255,.95);
    }
    input[type="text"]:focus{border-color: rgba(79,124,255,.55); box-shadow: 0 0 0 4px rgba(79,124,255,.12)}
    .progress{
      margin-top:12px;
      height:10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.7);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(79,124,255,.90), rgba(51,194,161,.90));
      transition: width .15s linear;
    }

    .status{
      margin-top:10px;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.8);
      font-size:12px;
      color:var(--muted);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      display:none;
      z-index: 999;
      font-size:13px;
    }

    .danger{color:var(--bad); font-weight:800}
    .ok{color: #1f7a4b; font-weight:800}
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ç›®æŒ‡ã›ï¼ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¹ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ï¼ˆã‚½ãƒ­ï¼‰</h1>
          <div class="sub">è¡¨ç¤ºã¯æ—¥æœ¬èª / å…¥åŠ›ã¯ãƒ­ãƒ¼ãƒå­—ï¼ˆäº’æ›OKï¼‰</div>
        </div>
      </div>
      <div class="top">
        <button class="chip" id="btnBack" type="button">â¬… <span class="v">åºƒå ´ã¸</span></button>
        <button class="chip" id="btnSettings" type="button">âš™ï¸ <span class="v">è¨­å®š</span></button>
        <span class="badge">ğŸ“¦ texts_ja.json é€£æº</span>
      </div>
    </header>

    <div class="grid">
      <!-- ãƒ¡ã‚¤ãƒ³ -->
      <section class="card">
        <div class="pad">
          <div class="row">
            <div class="stat">
              <div class="label">çŠ¶æ…‹</div>
              <div class="value" id="uiState">æº–å‚™ä¸­</div>
            </div>
            <div class="stat">
              <div class="label">æ®‹ã‚Šæ™‚é–“</div>
              <div class="value mono" id="uiTime">60.0</div>
            </div>
            <div class="stat">
              <div class="label">å•é¡Œæ•°</div>
              <div class="value mono"><span id="uiDone">0</span>/<span id="uiTotal">10</span></div>
            </div>
          </div>

          <div style="margin-top:14px" class="typingBox">
            <div class="jp" id="uiJp">ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦é–‹å§‹</div>
            <div class="kana mono" id="uiKana">ï¼ˆã“ã“ã« ã²ã‚‰ãŒãª ãŒå‡ºã¾ã™ï¼‰</div>
            <div class="hint">â€»å…¥åŠ›æ¬„ã«ã¯ãƒ­ãƒ¼ãƒå­—ã‚’æ‰“ã£ã¦ãã ã•ã„ã€‚ä¾‹ï¼šã— â†’ <span class="mono">shi</span> / <span class="mono">si</span></div>

            <div class="inputRow">
              <input id="typeInput" type="text" inputmode="latin" autocomplete="off" autocapitalize="off" spellcheck="false"
                     placeholder="ã“ã“ã«ãƒ­ãƒ¼ãƒå­—ã§å…¥åŠ›" disabled />
              <button class="btn primary" id="btnStart" type="button">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
              <button class="btn" id="btnRestart" type="button">â†» ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>

            <div class="progress" aria-label="é€²æ—">
              <div class="bar" id="bar"></div>
            </div>

            <div class="status">
              <div>å…¥åŠ›: <span class="mono" id="uiTyped">""</span></div>
              <div>åˆ¤å®š: <span id="uiJudge" class="ok">OK</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ã‚µã‚¤ãƒ‰ -->
      <aside class="card">
        <div class="pad">
          <div class="row">
            <div class="stat">
              <div class="label">WPMï¼ˆæ¨å®šï¼‰</div>
              <div class="value" id="uiWpm">-</div>
            </div>
            <div class="stat">
              <div class="label">Accuracy</div>
              <div class="value" id="uiAcc">-</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="stat">
              <div class="label">ãƒŸã‚¹æ•°</div>
              <div class="value" id="uiMiss">0</div>
            </div>
            <div class="stat">
              <div class="label">ç·ã‚­ãƒ¼æ•°</div>
              <div class="value" id="uiKeys">0</div>
            </div>
          </div>

          <div style="margin-top:14px; border-top:1px solid var(--line); padding-top:14px">
            <div class="row">
              <div class="stat">
                <div class="label">è‡ªå·±ãƒ™ã‚¹ãƒˆ WPM</div>
                <div class="value" id="uiBestWpm">-</div>
              </div>
              <div class="stat">
                <div class="label">è‡ªå·±ãƒ™ã‚¹ãƒˆ Accuracy</div>
                <div class="value" id="uiBestAcc">-</div>
              </div>
            </div>
            <div class="hint" style="margin-top:10px">
              è¨­å®šã¨ãƒ™ã‚¹ãƒˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã€‚Firebaseãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã§æ¥ç¶šã§ãã¾ã™ã€‚
            </div>
          </div>

          <div style="margin-top:14px; border-top:1px solid var(--line); padding-top:14px">
            <div class="label">é›£æ˜“åº¦ï¼ˆæ–‡ç« ã®é•·ã•ï¼‰</div>
            <div class="row" style="margin-top:8px">
              <button class="btn" data-diff="easy" type="button">ã‹ã‚“ãŸã‚“ï¼ˆshortï¼‰</button>
              <button class="btn" data-diff="normal" type="button">ãµã¤ã†ï¼ˆmediumï¼‰</button>
              <button class="btn" data-diff="hard" type="button">ã‚€ãšã‹ã—ã„ï¼ˆlongï¼‰</button>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <!-- Firebaseï¼ˆç¾æ®µéšã§ã¯â€œå…¥ã‚Œã¦ã‚‚å…¥ã‚Œãªãã¦ã‚‚â€å‹•ãï¼‰ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD65FaPtQiKdfl2IOiJlWCrFWAwQVhPnNI",
      authDomain: "typing-hiroba.firebaseapp.com",
      projectId: "typing-hiroba",
      storageBucket: "typing-hiroba.firebasestorage.app",
      messagingSenderId: "237978409938",
      appId: "1:237978409938:web:b311531f356ae2e135060b",
      measurementId: "G-G06Q1Y899Y"
    };

    try{
      const app = initializeApp(firebaseConfig);
      getAnalytics(app);
    }catch(e){
      // ãƒ­ãƒ¼ã‚«ãƒ«(file://)ã§é–‹ãã¨ analytics ãŒå¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ç„¡è¦–
      console.warn("Firebase init skipped:", e?.message || e);
    }
  </script>

  <!-- Game Logic -->
  <script type="module">
    import { ROMAJI_TABLE } from "./romaji_table.js";

    // ==========
    // LocalStorage
    // ==========
    const LS = {
      SETTINGS: "typing_plaza_settings_v1",
      SPRINTER: "typing_sprinter_stats_v1"
    };

    const defaultSettings = {
      playerName: "Guest",
      difficulty: "normal", // easy/normal/hard
      sound: "on"
    };

    const defaultSprinterStats = {
      bestWpm: null,
      bestAcc: null
    };

    const $ = (id) => document.getElementById(id);

    function safeParse(json, fallback){
      try { return JSON.parse(json) ?? fallback; } catch { return fallback; }
    }

    function loadSettings(){
      const s = safeParse(localStorage.getItem(LS.SETTINGS), defaultSettings);
      return { ...defaultSettings, ...s };
    }
    function saveSettings(v){
      localStorage.setItem(LS.SETTINGS, JSON.stringify(v));
    }
    function loadBest(){
      const s = safeParse(localStorage.getItem(LS.SPRINTER), defaultSprinterStats);
      return { ...defaultSprinterStats, ...s };
    }
    function saveBest(v){
      localStorage.setItem(LS.SPRINTER, JSON.stringify(v));
    }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=>{ t.style.display = "none"; }, 2200);
    }

    // ==========
    // texts_ja.json load
    // ==========
    let TEXTS = null; // {short:[{id,jp,kana}], medium:..., long:...}

    async function loadTexts(){
      const res = await fetch("./texts_ja.json", { cache:"no-store" });
      if(!res.ok) throw new Error("texts_ja.json ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ");
      const json = await res.json();
      if(!json.short || !json.medium || !json.long) throw new Error("texts_ja.json ã®å½¢å¼ãŒæƒ³å®šã¨é•ã„ã¾ã™");
      TEXTS = json;
    }

    function pickPoolByDifficulty(diff){
      if(!TEXTS) return [];
      if(diff === "easy") return TEXTS.short;
      if(diff === "hard") return TEXTS.long;
      return TEXTS.medium; // normal
    }

    function sampleQuestions(pool, n){
      const a = [...pool];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a.slice(0, Math.min(n, a.length));
    }

    // ==========
    // Romaji matcher (multi-accepted)
    // ==========
    // ã‹ãªæ–‡å­—åˆ—ã‚’ã€è¨±å¯ã•ã‚Œã‚‹ãƒ­ãƒ¼ãƒå­—ç³»åˆ—ã¸ï¼ˆè¤‡æ•°å€™è£œï¼‰ã¨ã—ã¦æ‰±ã„ã€å…¥åŠ›ã«å¯¾ã—ã¦å‰æ–¹ä¸€è‡´ã§é€²ã‚ã‚‹ã€‚
    // å®Ÿè£…ã¯ã€Œç¾åœ¨ä½ç½®idxã€ï¼‹ã€Œæ®‹ã‚Šè¨±å®¹å€™è£œç¾¤ã€ã‚’çŠ¶æ…‹ã¨ã—ã¦æ›´æ–°ã™ã‚‹æ–¹å¼ã€‚

    function buildTokenOptions(kana){
      // æœ€å¤§é•·3ï¼ˆæ‹—éŸ³ã€Œã—ã‚ƒã€ãªã©ï¼‰ã‚’å„ªå…ˆãƒãƒƒãƒ
      const tokens = [];
      for(let i=0;i<kana.length;){
        let chunk = null;

        // 3æ–‡å­—/2æ–‡å­—/1æ–‡å­—ã®é †ã§è¾æ›¸ã«ã‚ã‚‹ã‹ç¢ºèª
        for(const len of [3,2,1]){
          const s = kana.slice(i, i+len);
          if(ROMAJI_TABLE[s]){
            chunk = s;
            break;
          }
        }

        // ã€Œã£ã€ã®ç‰¹åˆ¥æ‰±ã„ã¯ token ã¨ã—ã¦ä¿æŒï¼ˆå¾Œã§å­éŸ³é‡ã­ã‚’è¨±å®¹ï¼‰
        if(!chunk){
          // æœªå®šç¾©æ–‡å­—ãŒæ¥ãŸå ´åˆã¯ãã®ã¾ã¾ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã“ã“ã§è½ã¨ã™ã‚ˆã‚Šé‹ç”¨ç¶™ç¶šï¼‰
          tokens.push({ kind:"raw", kana:kana[i], options: [] });
          i += 1;
          continue;
        }

        tokens.push({ kind:"kana", kana: chunk, options: ROMAJI_TABLE[chunk] });
        i += chunk.length;
      }
      return tokens;
    }

    function isConsonant(ch){
      return /^[bcdfghjklmnpqrstvwxyz]$/.test(ch);
    }

    // 1å•åˆ†ã®ã€Œè¨±å¯ã•ã‚Œã‚‹å…¥åŠ›ã€çŠ¶æ…‹ã‚’ä½œã‚‹
    function createMatcherState(kana){
      const tokens = buildTokenOptions(kana);
      return {
        tokens,
        tokenIndex: 0,
        // tokenã”ã¨ã®å€™è£œã‚’çŠ¶æ…‹ã¨ã—ã¦æŒã¤ï¼ˆä¾‹ï¼šã— -> ["shi","si"]ï¼‰
        // currentCandidates ã¯ã€Œä»Šã®tokenã§æ®‹ã£ã¦ã„ã‚‹å€™è£œï¼ˆæœªæ¶ˆåŒ–ï¼‰ã€ã®é…åˆ—
        currentCandidates: null,
        // ä¿ƒéŸ³ï¼ˆã£ï¼‰å¯¾å¿œç”¨ï¼šæ¬¡ã®å­éŸ³ã‚’é‡ã­ã‚‹è¨±å®¹
        pendingSmallTsu: false
      };
    }

    function ensureCandidates(st){
      if(st.currentCandidates) return;
      // tokenIndex ãŒç¯„å›²å¤–ãªã‚‰çµ‚ç«¯
      if(st.tokenIndex >= st.tokens.length){
        st.currentCandidates = [];
        return;
      }

      const tk = st.tokens[st.tokenIndex];

      if(tk.kind === "kana"){
        // ä¿ƒéŸ³ãƒˆãƒ¼ã‚¯ãƒ³ãªã‚‰ã€æ¬¡ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«é€²ã‚ã¤ã¤ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        if(tk.kana === "ã£"){
          st.pendingSmallTsu = true;
          st.tokenIndex++;
          st.currentCandidates = null;
          ensureCandidates(st);
          return;
        }
        st.currentCandidates = tk.options.map(s => s.toLowerCase());
        return;
      }

      // raw ã¯å…¥åŠ›å¯¾è±¡å¤–ã¨ã—ã¦é£›ã°ã™ï¼ˆå®‰å…¨é‹ç”¨ï¼‰
      st.tokenIndex++;
      st.currentCandidates = null;
      ensureCandidates(st);
    }

    // å…¥åŠ›1æ–‡å­—ã‚’é£Ÿã¹ã‚‰ã‚Œã‚‹ã‹ï¼ˆé£Ÿã¹ãŸã‚‰ state ã‚’æ›´æ–°ï¼‰
    function consumeChar(st, ch){
      ch = ch.toLowerCase();
      ensureCandidates(st);

      // ã‚‚ã†çµ‚ã‚ã‚Š
      if(st.tokenIndex >= st.tokens.length){
        return { ok:false, done:true };
      }

      // ä¿ƒéŸ³ï¼ˆã£ï¼‰: æ¬¡ã®tokenã®å€™è£œã®å…ˆé ­å­éŸ³ã‚’1å›ä½™è¨ˆã«æ‰“ã¦ã‚‹
      if(st.pendingSmallTsu){
        // æ¬¡ã®tokenå€™è£œã®å…ˆé ­å­éŸ³ï¼ˆä¾‹ï¼ška->k, shi->sï¼‰ã«ä¸€è‡´ã—ãŸã‚‰æ¶ˆè²»OKã¨ã—ã¦ãƒ•ãƒ©ã‚°è§£é™¤ã—ã€
        // tokenIndexã¯é€²ã‚ãšï¼ˆæ¬¡tokenã‚’é€šå¸¸å‡¦ç†ã§æ‰“ã¤ï¼‰
        ensureCandidates(st);
        const can = st.currentCandidates || [];
        const headSet = new Set();
        for(const cand of can){
          const head = cand[0];
          if(head) headSet.add(head);
        }
        if(headSet.has(ch) && isConsonant(ch)){
          st.pendingSmallTsu = false;
          return { ok:true, done:false };
        }
        // ä¿ƒéŸ³ä¸­ã§ã‚‚é€šå¸¸ã®æ¶ˆè²»ã‚’è¨±ã™ã¨å£Šã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯NG
        return { ok:false, done:false };
      }

      const cands = st.currentCandidates || [];
      // å€™è£œã®ã†ã¡ã€å…ˆé ­ãŒ ch ã®ã‚‚ã®ã ã‘æ®‹ã™ï¼ˆå…ˆé ­1æ–‡å­—ã‚’å‰Šã‚‹ï¼‰
      const next = [];
      for(const cand of cands){
        if(cand.startsWith(ch)){
          const rest = cand.slice(1);
          next.push(rest);
        }
      }

      if(next.length === 0){
        return { ok:false, done:false };
      }

      // å€™è£œæ›´æ–°
      st.currentCandidates = next;

      // å€™è£œã®ä¸­ã«ç©ºæ–‡å­—ãŒã‚ã‚Œã°ã€ãã®tokenãŒå®Œäº†ï¼ˆãŸã ã—ä»–å€™è£œãŒæ®‹ã£ã¦ã„ã¦ã‚‚ã€æœ€çŸ­ã§é€²ã‚ã¦ã‚ˆã„ï¼‰
      if(st.currentCandidates.some(x => x.length === 0)){
        // æ¬¡tokenã¸é€²ã‚€
        st.tokenIndex++;
        st.currentCandidates = null;
        ensureCandidates(st);
      }

      const done = (st.tokenIndex >= st.tokens.length);
      return { ok:true, done };
    }

    // ==========
    // Game (Sprinter Solo)
    // ==========
    const GAME = {
      totalQuestions: 10,
      timeLimitSec: 60.0
    };

    let settings = loadSettings();
    let best = loadBest();

    let questions = [];
    let qIndex = 0;

    let matcher = null;
    let started = false;
    let ended = false;

    let startTs = 0;
    let timerId = null;

    // metrics
    let totalKeystrokes = 0;
    let missCount = 0;
    let correctKeystrokes = 0;

    function fmtWpm(v){
      if(v == null) return "-";
      return `${Math.round(v)} WPM`;
    }
    function fmtAcc(v){
      if(v == null) return "-";
      return `${v.toFixed(1)}%`;
    }

    function renderBest(){
      $("uiBestWpm").textContent = fmtWpm(best.bestWpm);
      $("uiBestAcc").textContent = fmtAcc(best.bestAcc);
    }

    function setStateLabel(s){
      $("uiState").textContent = s;
    }

    function setQuestion(idx){
      qIndex = idx;
      const q = questions[qIndex];
      $("uiJp").textContent = q.jp;
      $("uiKana").textContent = q.kana;
      $("uiDone").textContent = String(qIndex);
      $("uiTotal").textContent = String(questions.length);
      $("uiTyped").textContent = '""';
      $("uiJudge").textContent = "OK";
      $("uiJudge").className = "ok";
      $("typeInput").value = "";
      $("bar").style.width = `${(qIndex / questions.length) * 100}%`;
      matcher = createMatcherState(q.kana);
    }

    function resetMetrics(){
      totalKeystrokes = 0;
      missCount = 0;
      correctKeystrokes = 0;
      $("uiKeys").textContent = "0";
      $("uiMiss").textContent = "0";
      $("uiWpm").textContent = "-";
      $("uiAcc").textContent = "-";
    }

    function stopTimer(){
      if(timerId){ clearInterval(timerId); timerId = null; }
    }

    function currentTimeLeft(){
      const t = (performance.now() - startTs) / 1000;
      return Math.max(0, GAME.timeLimitSec - t);
    }

    function updateHud(){
      const left = currentTimeLeft();
      $("uiTime").textContent = left.toFixed(1);

      const elapsedMin = Math.max(0.001, (performance.now()-startTs)/1000/60);
      // WPMã®ä¸€èˆ¬çš„ãªè¨ˆç®—ï¼šæ­£è§£ã‚­ãƒ¼/5/åˆ†
      const wpm = (correctKeystrokes / 5) / elapsedMin;
      const acc = totalKeystrokes === 0 ? 100 : (correctKeystrokes / totalKeystrokes) * 100;

      $("uiWpm").textContent = Number.isFinite(wpm) ? `${Math.round(wpm)} WPM` : "-";
      $("uiAcc").textContent = Number.isFinite(acc) ? `${acc.toFixed(1)}%` : "-";

      $("uiKeys").textContent = String(totalKeystrokes);
      $("uiMiss").textContent = String(missCount);

      if(left <= 0){
        endGame("ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—");
      }
    }

    function endGame(reason){
      if(ended) return;
      ended = true;
      started = false;
      stopTimer();
      $("typeInput").disabled = true;

      // final metrics
      const elapsedMin = Math.max(0.001, (performance.now()-startTs)/1000/60);
      const wpm = (correctKeystrokes / 5) / elapsedMin;
      const acc = totalKeystrokes === 0 ? 0 : (correctKeystrokes / totalKeystrokes) * 100;

      setStateLabel(`çµ‚äº†ï¼ˆ${reason}ï¼‰`);

      // best update
      let updated = false;
      if(Number.isFinite(wpm) && (best.bestWpm == null || wpm > best.bestWpm)){
        best.bestWpm = wpm;
        updated = true;
      }
      if(Number.isFinite(acc) && (best.bestAcc == null || acc > best.bestAcc)){
        best.bestAcc = acc;
        updated = true;
      }
      if(updated){
        saveBest(best);
        renderBest();
        toast("è‡ªå·±ãƒ™ã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ");
      }else{
        toast("çµæœã‚’è¨˜éŒ²ã—ã¾ã—ãŸ");
      }

      // progress 100%
      $("bar").style.width = `100%`;
    }

    function startGame(){
      if(!TEXTS){
        toast("texts_ja.json ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦");
        return;
      }

      settings = loadSettings();

      const pool = pickPoolByDifficulty(settings.difficulty);
      questions = sampleQuestions(pool, GAME.totalQuestions);

      if(questions.length < GAME.totalQuestions){
        toast("æ–‡ç« æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆtexts_ja.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
        return;
      }

      resetMetrics();
      ended = false;
      started = true;

      setStateLabel("ãƒ—ãƒ¬ã‚¤ä¸­");
      $("typeInput").disabled = false;
      $("typeInput").focus();

      setQuestion(0);

      startTs = performance.now();
      stopTimer();
      timerId = setInterval(updateHud, 50);
      updateHud();
    }

    function restartGame(){
      stopTimer();
      $("typeInput").disabled = true;
      setStateLabel("æº–å‚™ä¸­");
      $("uiTime").textContent = GAME.timeLimitSec.toFixed(1);
      $("uiDone").textContent = "0";
      $("uiTotal").textContent = String(GAME.totalQuestions);
      $("uiJp").textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦é–‹å§‹";
      $("uiKana").textContent = "ï¼ˆã“ã“ã« ã²ã‚‰ãŒãª ãŒå‡ºã¾ã™ï¼‰";
      $("uiTyped").textContent = '""';
      $("uiJudge").textContent = "OK";
      $("uiJudge").className = "ok";
      $("bar").style.width = "0%";
      resetMetrics();
      started = false;
      ended = false;
    }

    function advanceQuestion(){
      const nextIdx = qIndex + 1;
      if(nextIdx >= questions.length){
        endGame("å®Œèµ°");
        return;
      }
      setQuestion(nextIdx);
      $("bar").style.width = `${(nextIdx / questions.length) * 100}%`;
    }

    // ==========
    // Input handling
    // ==========
    $("typeInput").addEventListener("keydown", (e) => {
      if(!started || ended) return;

      // ä½¿ã‚ãªã„ã‚­ãƒ¼ã¯ç„¡è¦–
      if(e.key.length !== 1) return;

      const ch = e.key;
      if(!/^[a-zA-Z-.,]$/.test(ch)){
        // è¨±å®¹æ–‡å­—ã‚’å¢—ã‚„ã—ãŸã„ãªã‚‰ã“ã“ã‚’æ‹¡å¼µ
        e.preventDefault();
        return;
      }

      totalKeystrokes++;

      const r = consumeChar(matcher, ch);
      if(r.ok){
        correctKeystrokes++;
        $("uiJudge").textContent = "OK";
        $("uiJudge").className = "ok";
      }else{
        missCount++;
        $("uiJudge").textContent = "MISS";
        $("uiJudge").className = "danger";
      }

      // å…¥åŠ›æ¬„ã¯ã€Œè¦‹ãŸç›®ç”¨ã€ãªã®ã§ã€å®Ÿã‚­ãƒ¼ã¯ã“ã“ã§åæ˜ 
      const v = $("typeInput").value + ch.toLowerCase();
      $("typeInput").value = v;
      $("uiTyped").textContent = `"${v}"`;

      updateHud();

      if(r.ok && r.done){
        // æ¬¡ã®å•é¡Œã¸ï¼ˆå…¥åŠ›æ¬„ã¯ãƒªã‚»ãƒƒãƒˆï¼‰
        advanceQuestion();
      }

      e.preventDefault();
    });

    // ==========
    // UI buttons
    // ==========
    $("btnStart").addEventListener("click", startGame);
    $("btnRestart").addEventListener("click", () => {
      restartGame();
      toast("ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸ");
    });

    // åºƒå ´ã¸ï¼ˆä»Šã¯ä»®ï¼šindex.html ã¸æˆ»ã™æƒ³å®šï¼‰
    $("btnBack").addEventListener("click", () => {
      location.href = "./index.html";
    });

    // è¨­å®šï¼ˆä»Šå›ã¯æœ€å°ï¼šé›£æ˜“åº¦åˆ‡æ›¿ã ã‘ï¼‰
    $("btnSettings").addEventListener("click", () => {
      toast("è¨­å®šï¼šå³å´ã®é›£æ˜“åº¦ãƒœã‚¿ãƒ³ã§æ–‡ç« ã®é•·ã•ã‚’åˆ‡æ›¿ã§ãã¾ã™");
    });

    // é›£æ˜“åº¦ãƒœã‚¿ãƒ³
    document.querySelectorAll("[data-diff]").forEach(btn => {
      btn.addEventListener("click", () => {
        const diff = btn.getAttribute("data-diff");
        const s = loadSettings();
        s.difficulty = diff;
        saveSettings(s);
        toast(`é›£æ˜“åº¦ã‚’å¤‰æ›´ã—ã¾ã—ãŸï¼š${diff === "easy" ? "ã‹ã‚“ãŸã‚“" : diff === "hard" ? "ã‚€ãšã‹ã—ã„" : "ãµã¤ã†"}`);
      });
    });

    // ==========
    // Init
    // ==========
    renderBest();
    restartGame();

    try{
      await loadTexts();
      toast("texts_ja.json ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
    }catch(e){
      console.error(e);
      toast("texts_ja.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆé…ç½®ã¨åå‰ã‚’ç¢ºèªï¼‰");
    }
  </script>
</body>
</html>
