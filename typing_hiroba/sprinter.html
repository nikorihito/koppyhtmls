<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç›®æŒ‡ã›ï¼ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¹ãƒ—ãƒªãƒ³ã‚¿ãƒ¼</title>
  <meta name="description" content="æ—¥æœ¬èªè¡¨ç¤ºÃ—ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ã§ã€WPM/Accuracy/Timeã‚’ç«¶ã†ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ¬ãƒ¼ã‚¹" />
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(18,26,51,.86);
      --text:#eaf0ff;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.12);
      --accent:#7c5cff;
      --good:#35d07f;
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --shadow:0 18px 45px rgba(0,0,0,.40);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background:
        linear-gradient(to bottom, rgba(11,16,32,.65), rgba(11,16,32,.90)),
        url("./sprinter_bg.png");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    a{color:inherit;text-decoration:none}
    button,input{font:inherit}

    .wrap{max-width:1100px;margin:0 auto;padding:22px 16px 64px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;
      background:rgba(11,16,32,.55);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      position:sticky;top:12px;z-index:20;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.22), transparent 45%),
                  linear-gradient(135deg, rgba(124,92,255,.95), rgba(53,208,127,.60));
      box-shadow:0 10px 25px rgba(124,92,255,.18);
    }
    .brand h1{margin:0;font-size:15px;letter-spacing:.04em}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:12px}

    .top-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      cursor:pointer;transition:.15s ease;
    }
    .chip:hover{transform:translateY(-1px);background:rgba(255,255,255,.08)}
    .chip .v{color:var(--muted);font-weight:700}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .pad{padding:16px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .stat{
      flex:1 1 160px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      padding:10px 12px;
    }
    .stat .k{color:var(--muted);font-size:11px}
    .stat .v{margin-top:4px;font-weight:800;font-size:16px}

    .progress{
      height:10px;border-radius:999px;overflow:hidden;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(124,92,255,.85), rgba(53,208,127,.70));
      transition: width .15s linear;
    }

    .question{
      margin-top:12px;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
    }
    .jp{font-size:22px;font-weight:900;letter-spacing:.02em}
    .kana{margin-top:6px;color:var(--muted);font-size:13px}
    .target{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      font-size:14px;
      line-height:1.6;
    }
    .target .done{color:rgba(234,240,255,.95)}
    .target .todo{color:rgba(159,176,208,.95)}
    .target .cursor{display:inline-block;min-width:10px;border-bottom:2px solid rgba(255,255,255,.35)}

    .inputbox{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }
    input[type="text"]{
      flex: 1 1 360px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    input[type="text"]:focus{border-color: rgba(124,92,255,.55); box-shadow:0 0 0 4px rgba(124,92,255,.14)}
    .btn{
      padding:11px 12px;border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;transition:.15s ease;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.08)}
    .btn.primary{
      border-color: rgba(124,92,255,.55);
      background: linear-gradient(135deg, rgba(124,92,255,.25), rgba(255,255,255,.06));
    }
    .btn.danger{
      border-color: rgba(255,92,122,.55);
      background: linear-gradient(135deg, rgba(255,92,122,.18), rgba(255,255,255,.06));
    }

    .muted{color:var(--muted)}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.6}
    .warn{color:var(--warn)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(18,26,51,.92);
      color:var(--text);
      display:none;z-index:1000;
      box-shadow:0 12px 35px rgba(0,0,0,.35);
      font-size:13px;
    }
    .shake{animation: shake .12s linear 0s 2}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-3px)}
      50%{transform:translateX(3px)}
      75%{transform:translateX(-2px)}
      100%{transform:translateX(0)}
    }

    .modal-backdrop{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.62);
      padding:18px; z-index:999;
    }
    .modal{
      width:min(760px, 100%);
      border-radius:22px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,26,51,.98), rgba(15,22,48,.95));
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal .head{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background: rgba(255,255,255,.03);
    }
    .modal .body{padding:16px}
    .modal .actions{
      padding:14px 16px;border-top:1px solid var(--line);
      display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap;
      background: rgba(255,255,255,.02);
    }
    .field{
      padding:12px;border:1px solid var(--line);
      border-radius:16px;background:rgba(255,255,255,.04);
    }
    .field label{display:block;color:var(--muted);font-size:12px;margin-bottom:8px}
    .field input{
      width:100%;
      padding:10px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
    }
    footer{margin-top:16px;color:var(--muted);font-size:12px;opacity:.95}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ç›®æŒ‡ã›ï¼ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¹ãƒ—ãƒªãƒ³ã‚¿ãƒ¼</h1>
          <p>æ—¥æœ¬èªè¡¨ç¤º Ã— ãƒ­ãƒ¼ãƒå­—å…¥åŠ› / WPMãƒ»Accuracyãƒ»Time</p>
        </div>
      </div>
      <div class="top-actions">
        <button class="chip" id="btnBack" type="button" title="æˆ»ã‚‹ï¼ˆåºƒå ´ã¸ï¼‰">
          <span>â¬…</span><span class="v">åºƒå ´ã¸</span>
        </button>
        <button class="chip" id="btnProfile" type="button" title="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«">
          <span>ğŸ‘¤</span><span class="v" id="uiPlayerName">Guest</span>
        </button>
        <button class="chip" id="btnSettings" type="button" title="è¨­å®š">
          <span>âš™ï¸</span><span class="v">è¨­å®š</span>
        </button>
      </div>
    </header>

    <div class="grid">
      <!-- Game -->
      <section class="card">
        <div class="pad">
          <div class="row">
            <div class="stat"><div class="k">çŠ¶æ…‹</div><div class="v" id="uiState">å¾…æ©Ÿä¸­</div></div>
            <div class="stat"><div class="k">WPM</div><div class="v" id="uiWpm">-</div></div>
            <div class="stat"><div class="k">Accuracy</div><div class="v" id="uiAcc">-</div></div>
            <div class="stat"><div class="k">Time</div><div class="v" id="uiTime">0.00s</div></div>
          </div>

          <div style="margin-top:12px">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="muted">é€²æ— <span class="mono" id="uiProgressText">0/10</span></div>
              <div class="muted">æ¥ç¶š <span class="mono" id="uiNet">Firebase: â€¦</span></div>
            </div>
            <div class="progress" aria-label="é€²æ—ãƒãƒ¼"><div class="bar" id="bar"></div></div>
          </div>

          <div class="question" style="margin-top:14px">
            <div class="jp" id="qJp">â€”</div>
            <div class="kana mono" id="qKana">â€”</div>

            <div class="target mono" id="qTarget">
              <span class="done"></span><span class="cursor"></span><span class="todo"></span>
            </div>

            <div class="inputbox">
              <input id="typingInput" type="text" inputmode="latin" autocomplete="off" autocapitalize="off" spellcheck="false"
                     placeholder="è‹±å­—ï¼ˆãƒ­ãƒ¼ãƒå­—ï¼‰ã§å…¥åŠ› / Backspaceã§æˆ»ã‚‹" />
              <button class="btn primary" id="btnStart" type="button">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
              <button class="btn" id="btnRetry" type="button">ğŸ” ãƒªãƒˆãƒ©ã‚¤</button>
              <button class="btn danger" id="btnGiveUp" type="button">â›” ä¸­æ–­</button>
            </div>

            <div class="hint">
              âœ… ãƒ­ãƒ¼ãƒå­—æºã‚Œå¯¾å¿œï¼ˆä¾‹ï¼šã—ï¼ <span class="mono">shi / si</span>ï¼‰<br/>
              âœ… ãƒŸã‚¹å…¥åŠ›ã¯é€²ã¾ãšã€ãƒŸã‚¹ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆï¼ˆç«¶æŠ€å‘ã‘ï¼‰<br/>
              <span class="warn">â€»æœ€åˆã«Firestoreã¸ä¿å­˜ã™ã‚‹ãŸã‚ã€åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ãŒèµ°ã‚Šã¾ã™ã€‚</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Best & Info -->
      <aside class="card">
        <div class="pad">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
            <div>
              <div style="font-weight:900">è‡ªå·±ãƒ™ã‚¹ãƒˆï¼ˆã“ã®ç«¯æœ«ï¼‰</div>
              <div class="muted" style="font-size:12px;margin-top:4px">Local + Firestoreï¼ˆè‡ªåˆ†ã®ã¿ï¼‰</div>
            </div>
            <div class="muted mono" id="uidShort">uid: â€¦</div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="stat"><div class="k">Best WPM</div><div class="v" id="bestWpm">-</div></div>
            <div class="stat"><div class="k">Best Acc</div><div class="v" id="bestAcc">-</div></div>
            <div class="stat"><div class="k">Best Time</div><div class="v" id="bestTime">-</div></div>
            <div class="stat"><div class="k">Best Date</div><div class="v" id="bestDate">-</div></div>
          </div>

          <div class="field" style="margin-top:12px">
            <label>ãƒ¬ãƒ¼ã‚¹è¨­å®š</label>
            <div class="muted" style="font-size:13px;line-height:1.6">
              å•é¡Œæ•°ï¼š<span class="mono" id="cfgCount">10</span><br/>
              åˆ¶é™æ™‚é–“ï¼š<span class="mono">ãªã—ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼‰</span><br/>
              æ¡ç‚¹ï¼š<span class="mono">WPM / Accuracy / Time</span>
            </div>
          </div>

          <div class="field" style="margin-top:12px">
            <label>ãƒ¡ãƒ¢</label>
            <div class="muted" style="font-size:12px;line-height:1.6">
              ã“ã®ã‚¹ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ãŒâ€œå‹â€ã«ãªã‚Šã¾ã™ã€‚<br/>
              ã“ã“ãŒå®Œæˆã™ã‚Œã°ã€æ®‹ã‚Š3ã‚²ãƒ¼ãƒ ã¯åŒã˜ã‚¨ãƒ³ã‚¸ãƒ³ã§é«˜é€Ÿã«æ¨ªå±•é–‹ã§ãã¾ã™ã€‚
            </div>
          </div>

          <footer>Â© <span id="year"></span> Typing Hiroba / Sprinter v1.0</footer>
        </div>
      </aside>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-backdrop" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal">
      <div class="head">
        <div style="font-weight:900" id="settingsTitle">âš™ï¸ è¨­å®š</div>
        <button class="btn" type="button" data-close="settingsModal">âœ• é–‰ã˜ã‚‹</button>
      </div>
      <div class="body">
        <div class="field">
          <label for="playerName">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºç”¨ï¼‰</label>
          <input id="playerName" type="text" maxlength="16" placeholder="ä¾‹ï¼škoppy" />
          <div class="muted" style="margin-top:8px;font-size:12px;line-height:1.5">
            â€»MVPã§ã¯åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ + è¡¨ç¤ºåã‚’ä¿å­˜ã—ã¾ã™ï¼ˆæœ€å¤§16æ–‡å­—ï¼‰ã€‚
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" data-close="settingsModal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" type="button" id="saveSettings">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal-backdrop" id="profileModal" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
    <div class="modal">
      <div class="head">
        <div style="font-weight:900" id="profileTitle">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</div>
        <button class="btn" type="button" data-close="profileModal">âœ• é–‰ã˜ã‚‹</button>
      </div>
      <div class="body">
        <div class="field">
          <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
          <div class="mono" id="profileName">Guest</div>
        </div>
        <div class="field" style="margin-top:12px">
          <label>UID</label>
          <div class="mono" id="profileUid">â€¦</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" data-close="profileModal">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="resultModal" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
    <div class="modal">
      <div class="head">
        <div style="font-weight:900" id="resultTitle">ğŸ ãƒ¬ãƒ¼ã‚¹çµæœ</div>
        <button class="btn" type="button" data-close="resultModal">âœ• é–‰ã˜ã‚‹</button>
      </div>
      <div class="body">
        <div class="row">
          <div class="stat"><div class="k">WPM</div><div class="v" id="resWpm">-</div></div>
          <div class="stat"><div class="k">Accuracy</div><div class="v" id="resAcc">-</div></div>
          <div class="stat"><div class="k">Time</div><div class="v" id="resTime">-</div></div>
          <div class="stat"><div class="k">Miss</div><div class="v" id="resMiss">-</div></div>
        </div>
        <div class="field" style="margin-top:12px">
          <label>ä¿å­˜</label>
          <div class="muted" id="resSave">â€¦</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" id="btnResultRetry">ğŸ” ã‚‚ã†ä¸€å›</button>
        <button class="btn primary" type="button" id="btnResultClose" data-close="resultModal">OK</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // ===== Firebase (CDN) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    // ===== Romaji table =====
    import { ROMAJI_TABLE } from "./assets/romaji_table.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD65FaPtQiKdfl2IOiJlWCrFWAwQVhPnNI",
      authDomain: "typing-hiroba.firebaseapp.com",
      projectId: "typing-hiroba",
      storageBucket: "typing-hiroba.firebasestorage.app",
      messagingSenderId: "237978409938",
      appId: "1:237978409938:web:b311531f356ae2e135060b",
      measurementId: "G-G06Q1Y899Y"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const LS = {
      SETTINGS: "typing_settings_v1",
      SPRINTER_BEST: "sprinter_best_v1"
    };

    function safeParse(v, fallback){ try{ return JSON.parse(v) ?? fallback; } catch { return fallback; } }
    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=> t.style.display="none", 2200);
    }
    function openModal(id){ const el=$(id); if(el) el.style.display="flex"; }
    function closeModal(id){ const el=$(id); if(el) el.style.display="none"; }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-close]");
      if(btn){ closeModal(btn.getAttribute("data-close")); return; }
      if(e.target.classList.contains("modal-backdrop")) e.target.style.display="none";
    });

    function loadSettings(){
      return safeParse(localStorage.getItem(LS.SETTINGS), { playerName:"Guest" });
    }
    function saveSettings(v){
      localStorage.setItem(LS.SETTINGS, JSON.stringify(v));
    }

    function loadBest(){
      return safeParse(localStorage.getItem(LS.SPRINTER_BEST), null);
    }
    function saveBest(v){
      localStorage.setItem(LS.SPRINTER_BEST, JSON.stringify(v));
    }

    function fmtWpm(v){ return v==null ? "-" : `${Math.round(v)} WPM`; }
    function fmtAcc(v){ return v==null ? "-" : `${Math.max(0,Math.min(100,v)).toFixed(1)}%`; }
    function fmtTimeMs(ms){ return ms==null ? "-" : `${(ms/1000).toFixed(2)}s`; }
    function shortUid(uid){ return uid ? uid.slice(0,6)+"â€¦"+uid.slice(-4) : "â€¦"; }

    // ===== Kana -> Romaji candidates (supports variants) =====
    // We match by "candidates set". We avoid explosion by limiting candidates.
    const MAX_CANDIDATES = 512;

    function tokenizeKana(kana){
      // Handles digraphs first (2 chars), and keeps 'ã£' as token.
      const tokens = [];
      for(let i=0;i<kana.length;){
        const ch = kana[i];

        if(ch === "ã£"){
          tokens.push("ã£");
          i++;
          continue;
        }

        const two = kana.slice(i, i+2);
        if(ROMAJI_TABLE[two]){
          tokens.push(two);
          i += 2;
          continue;
        }

        const one = kana[i];
        tokens.push(one);
        i++;
      }
      return tokens;
    }

    function isVowel(c){ return ["a","i","u","e","o"].includes(c); }

    function expandRomajiCandidates(kana){
      const tokens = tokenizeKana(kana);
      let candidates = new Set([""]);

      for(let idx=0; idx<tokens.length; idx++){
        const t = tokens[idx];

        if(t === "ã£"){
          // sokuon: duplicate first consonant of next token's romaji
          const next = tokens[idx+1];
          const nextList = next ? ROMAJI_TABLE[next] : null;
          if(!nextList) continue; // orphan: ignore
          const newSet = new Set();
          for(const base of candidates){
            for(const r of nextList){
              const first = r[0];
              // only consonant doubling (if vowel, ignore)
              if(first && !isVowel(first)){
                newSet.add(base + first);
              }else{
                newSet.add(base);
              }
              if(newSet.size >= MAX_CANDIDATES) break;
            }
            if(newSet.size >= MAX_CANDIDATES) break;
          }
          candidates = newSet;
          continue;
        }

        const list = ROMAJI_TABLE[t];
        if(!list){
          // Unknown char: keep as-is (rare). This will likely never match.
          const newSet = new Set();
          for(const base of candidates){
            newSet.add(base + t);
            if(newSet.size >= MAX_CANDIDATES) break;
          }
          candidates = newSet;
          continue;
        }

        const newSet = new Set();
        for(const base of candidates){
          for(const r of list){
            newSet.add(base + r);
            if(newSet.size >= MAX_CANDIDATES) break;
          }
          if(newSet.size >= MAX_CANDIDATES) break;
        }
        candidates = newSet;
      }

      return Array.from(candidates);
    }

    // ===== Game state =====
    const RACE_COUNT = 10;

    const state = {
      uid: null,
      playerName: "Guest",
      texts: [],
      race: [],
      index: 0,
      started: false,
      finished: false,
      startAt: 0,
      timer: null,

      // current question
      q: null,                 // {jp,kana}
      candidates: [],          // expanded romaji candidates
      typed: "",

      // scoring
      correctKeystrokes: 0,
      missKeystrokes: 0,
      totalCorrectChars: 0
    };

    function setNetLabel(msg){ $("uiNet").textContent = msg; }

    function calcNowMs(){
      if(!state.started) return 0;
      return performance.now() - state.startAt;
    }

    function calcWpm(elapsedMs){
      if(elapsedMs <= 0) return 0;
      // Standard: (correct chars / 5) / minutes
      const minutes = elapsedMs / 60000;
      return (state.totalCorrectChars / 5) / minutes;
    }

    function calcAcc(){
      const total = state.correctKeystrokes + state.missKeystrokes;
      if(total <= 0) return 100;
      return (state.correctKeystrokes / total) * 100;
    }

    function renderStats(){
      const ms = calcNowMs();
      const wpm = state.started ? calcWpm(ms) : null;
      const acc = state.started ? calcAcc() : null;

      $("uiTime").textContent = `${(ms/1000).toFixed(2)}s`;
      $("uiWpm").textContent = state.started ? `${Math.round(wpm)} WPM` : "-";
      $("uiAcc").textContent = state.started ? `${acc.toFixed(1)}%` : "-";

      const progress = Math.min(1, (state.index) / RACE_COUNT);
      $("bar").style.width = `${progress*100}%`;
      $("uiProgressText").textContent = `${state.index}/${RACE_COUNT}`;
    }

    function renderQuestion(){
      if(!state.q){
        $("qJp").textContent = "â€”";
        $("qKana").textContent = "â€”";
        $("qTarget").querySelector(".done").textContent = "";
        $("qTarget").querySelector(".todo").textContent = "";
        return;
      }

      $("qJp").textContent = state.q.jp;
      $("qKana").textContent = `ã‚ˆã¿: ${state.q.kana}`;

      // Show canonical target = first candidate (display only)
      const canonical = state.candidates[0] ?? "";
      const typed = state.typed;

      const done = typed;
      const todo = canonical.slice(typed.length);

      $("qTarget").querySelector(".done").textContent = done;
      $("qTarget").querySelector(".todo").textContent = todo;
    }

    function setStateLabel(s){ $("uiState").textContent = s; }

    function pickRace(texts){
      // choose RACE_COUNT items (random with replacement if insufficient)
      const arr = [];
      for(let i=0;i<RACE_COUNT;i++){
        const item = texts[Math.floor(Math.random()*texts.length)];
        arr.push(item);
      }
      return arr;
    }

    function setQuestion(i){
      state.index = i;
      state.q = state.race[i] ?? null;
      state.typed = "";

      if(state.q){
        state.candidates = expandRomajiCandidates(state.q.kana);
        // canonical = shortest candidate first for nicer display
        state.candidates.sort((a,b)=>a.length-b.length);
      }else{
        state.candidates = [];
      }
      renderQuestion();
      renderStats();
    }

    function resetRun(){
      state.index = 0;
      state.started = false;
      state.finished = false;
      state.startAt = 0;
      state.typed = "";
      state.correctKeystrokes = 0;
      state.missKeystrokes = 0;
      state.totalCorrectChars = 0;
      clearInterval(state.timer);
      state.timer = null;

      setStateLabel("å¾…æ©Ÿä¸­");
      $("typingInput").value = "";
      $("typingInput").disabled = true;

      $("bar").style.width = `0%`;
      $("uiProgressText").textContent = `0/${RACE_COUNT}`;
      $("uiTime").textContent = `0.00s`;
      $("uiWpm").textContent = "-";
      $("uiAcc").textContent = "-";
    }

    function startRun(){
      if(state.texts.length === 0){
        toast("å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼ˆassets/texts_ja.json ã‚’ç¢ºèªï¼‰");
        return;
      }
      state.race = pickRace(state.texts);
      resetRun();

      setQuestion(0);

      state.started = true;
      state.startAt = performance.now();
      setStateLabel("ãƒ¬ãƒ¼ã‚¹ä¸­");
      $("typingInput").disabled = false;
      $("typingInput").focus();

      state.timer = setInterval(renderStats, 60);
      toast("ã‚¹ã‚¿ãƒ¼ãƒˆï¼");
    }

    function stopRun(label="ä¸­æ–­"){
      clearInterval(state.timer);
      state.timer = null;
      state.started = false;
      state.finished = false;
      setStateLabel(label);
      $("typingInput").disabled = true;
    }

    function isValidNextChar(nextTyped){
      // Accept if any candidate has this as prefix
      for(const c of state.candidates){
        if(c.startsWith(nextTyped)) return true;
      }
      return false;
    }

    function isComplete(){
      // Complete if any candidate equals typed
      return state.candidates.some(c => c === state.typed);
    }

    function advanceQuestion(){
      const nextIndex = state.index + 1;
      if(nextIndex >= RACE_COUNT){
        finishRun();
        return;
      }
      setQuestion(nextIndex);
      $("typingInput").value = "";
    }

    async function finishRun(){
      state.finished = true;
      clearInterval(state.timer);
      state.timer = null;

      const elapsedMs = performance.now() - state.startAt;
      const wpm = calcWpm(elapsedMs);
      const acc = calcAcc();
      const miss = state.missKeystrokes;

      setStateLabel("å®Œèµ°ï¼");
      $("typingInput").disabled = true;

      // result view
      $("resWpm").textContent = `${Math.round(wpm)} WPM`;
      $("resAcc").textContent = `${acc.toFixed(1)}%`;
      $("resTime").textContent = `${(elapsedMs/1000).toFixed(2)}s`;
      $("resMiss").textContent = `${miss}`;

      // save local best
      const nowIso = new Date().toISOString();
      const local = loadBest();
      const current = { bestWpm: wpm, bestAcc: acc, bestTimeMs: elapsedMs, bestAt: nowIso };

      let improved = false;
      if(!local){
        improved = true;
      }else{
        // primary: higher WPM, secondary: higher Acc, tertiary: faster time
        const a = current, b = local;
        const better =
          (a.bestWpm > b.bestWpm + 1e-6) ||
          (Math.abs(a.bestWpm - b.bestWpm) < 1e-6 && a.bestAcc > b.bestAcc + 1e-6) ||
          (Math.abs(a.bestWpm - b.bestWpm) < 1e-6 && Math.abs(a.bestAcc - b.bestAcc) < 1e-6 && a.bestTimeMs < b.bestTimeMs);
        improved = better;
      }
      if(improved) saveBest(current);

      renderBestPanel();

      // save firestore (self doc)
      $("resSave").textContent = "Firestoreã¸ä¿å­˜ä¸­â€¦";
      try{
        if(!state.uid) throw new Error("uidãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆåŒ¿åãƒ­ã‚°ã‚¤ãƒ³æœªå®Œäº†ï¼‰");
        const ref = doc(db, "leaderboards", "sprinter", "scores", state.uid);

        // Merge: keep best only (same comparison as local)
        const snap = await getDoc(ref);
        let remote = null;
        if(snap.exists()) remote = snap.data();

        const candidate = {
          uid: state.uid,
          name: state.playerName || "Guest",
          bestWpm: wpm,
          bestAcc: acc,
          bestTimeMs: elapsedMs,
          missCount: miss,
          updatedAt: serverTimestamp()
        };

        let shouldWrite = true;
        if(remote && typeof remote.bestWpm === "number"){
          const better =
            (candidate.bestWpm > remote.bestWpm + 1e-6) ||
            (Math.abs(candidate.bestWpm - remote.bestWpm) < 1e-6 && candidate.bestAcc > (remote.bestAcc ?? 0) + 1e-6) ||
            (Math.abs(candidate.bestWpm - remote.bestWpm) < 1e-6 && Math.abs(candidate.bestAcc - (remote.bestAcc ?? 0)) < 1e-6 && candidate.bestTimeMs < (remote.bestTimeMs ?? Number.MAX_SAFE_INTEGER));
          shouldWrite = better;
        }

        if(shouldWrite){
          await setDoc(ref, candidate, { merge:true });
          $("resSave").innerHTML = `<span class="good">ä¿å­˜ï¼šOK</span>ï¼ˆè‡ªåˆ†ã®ãƒ™ã‚¹ãƒˆã‚’æ›´æ–°ï¼‰`;
        }else{
          // still update name if changed (optional)
          await setDoc(ref, { name: candidate.name, updatedAt: serverTimestamp() }, { merge:true });
          $("resSave").innerHTML = `<span class="muted">ä¿å­˜ï¼šSKIP</span>ï¼ˆæ—¢ã«ã‚ˆã‚Šè‰¯ã„è¨˜éŒ²ãŒã‚ã‚Šã¾ã™ï¼‰`;
        }
      }catch(err){
        console.error(err);
        $("resSave").innerHTML = `<span class="bad">ä¿å­˜ï¼šNG</span>ï¼ˆãƒ«ãƒ¼ãƒ«/åŒ¿åãƒ­ã‚°ã‚¤ãƒ³/Hostingã‚’ç¢ºèªï¼‰`;
      }

      openModal("resultModal");
    }

    function renderBestPanel(){
      const b = loadBest();
      $("bestWpm").textContent = b ? fmtWpm(b.bestWpm) : "-";
      $("bestAcc").textContent = b ? fmtAcc(b.bestAcc) : "-";
      $("bestTime").textContent = b ? fmtTimeMs(b.bestTimeMs) : "-";
      $("bestDate").textContent = b ? new Date(b.bestAt).toLocaleString() : "-";
    }

    // ===== Input handling (accept only valid next char) =====
    function onKeyDown(e){
      if(!state.started || state.finished) return;

      const input = $("typingInput");

      if(e.key === "Backspace"){
        if(state.typed.length > 0){
          state.typed = state.typed.slice(0, -1);
          input.value = state.typed;
          renderQuestion();
        }else{
          input.value = "";
        }
        e.preventDefault();
        return;
      }

      // Ignore control keys
      if(e.ctrlKey || e.metaKey || e.altKey) return;
      if(e.key.length !== 1) return;

      const ch = e.key.toLowerCase();
      // allow a-z and '
      if(!(/[a-z']/).test(ch)) {
        e.preventDefault();
        return;
      }

      const next = state.typed + ch;
      if(isValidNextChar(next)){
        state.typed = next;
        input.value = state.typed;
        state.correctKeystrokes++;
        state.totalCorrectChars++; // accepted char as correct char
        renderQuestion();

        if(isComplete()){
          // Completed one phrase
          advanceQuestion();
        }
      }else{
        state.missKeystrokes++;
        // shake
        input.classList.remove("shake");
        void input.offsetWidth;
        input.classList.add("shake");
      }
      e.preventDefault();
    }

    // ===== Load texts =====
    async function loadTexts(){
      const res = await fetch("./assets/texts_ja.json", { cache:"no-store" });
      if(!res.ok) throw new Error("texts_ja.json not found");
      const json = await res.json();
      const list = json?.sprinter ?? [];
      // Validate schema
      state.texts = list.filter(x => x && typeof x.jp==="string" && typeof x.kana==="string");
      $("cfgCount").textContent = String(RACE_COUNT);
    }

    // ===== Auth =====
    async function ensureAuth(){
      setNetLabel("Firebase: èªè¨¼ä¸­â€¦");
      return new Promise((resolve)=>{
        onAuthStateChanged(auth, async (user)=>{
          if(user){
            state.uid = user.uid;
            $("uidShort").textContent = "uid: " + shortUid(state.uid);
            $("profileUid").textContent = state.uid;
            setNetLabel("Firebase: OK");
            resolve();
            return;
          }
          try{
            await signInAnonymously(auth);
          }catch(e){
            console.error(e);
            setNetLabel("Firebase: NG");
            toast("åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ï¼ˆAuthenticationâ†’Anonymousã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ï¼‰");
            resolve();
          }
        });
      });
    }

    // ===== UI Events =====
    $("btnStart").addEventListener("click", () => startRun());
    $("btnRetry").addEventListener("click", () => startRun());
    $("btnGiveUp").addEventListener("click", () => {
      if(!state.started){ toast("ã¾ã é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“"); return; }
      const ok = confirm("ãƒ¬ãƒ¼ã‚¹ã‚’ä¸­æ–­ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
      if(!ok) return;
      stopRun("ä¸­æ–­");
      toast("ä¸­æ–­ã—ã¾ã—ãŸ");
    });

    $("btnResultRetry").addEventListener("click", () => {
      closeModal("resultModal");
      startRun();
    });

    $("btnBack").addEventListener("click", () => {
      // åºƒå ´ãŒã‚ã‚‹å ´åˆã¯ index.html ã¸ã€‚ãªã‘ã‚Œã°ç„¡åŠ¹ã§ã‚‚OKã€‚
      location.href = "./index.html";
    });

    $("btnSettings").addEventListener("click", ()=>{
      const s = loadSettings();
      $("playerName").value = (s.playerName ?? "Guest");
      openModal("settingsModal");
    });
    $("saveSettings").addEventListener("click", ()=>{
      const next = { playerName: ($("playerName").value || "Guest").trim().slice(0,16) };
      saveSettings(next);
      state.playerName = next.playerName;
      $("uiPlayerName").textContent = state.playerName;
      $("profileName").textContent = state.playerName;
      closeModal("settingsModal");
      toast("ä¿å­˜ã—ã¾ã—ãŸ");
    });

    $("btnProfile").addEventListener("click", ()=>{
      $("profileName").textContent = state.playerName;
      $("profileUid").textContent = state.uid ?? "â€¦";
      openModal("profileModal");
    });

    $("typingInput").addEventListener("keydown", onKeyDown);

    // ===== Init =====
    (async function init(){
      const now = new Date();
      $("year").textContent = String(now.getFullYear());

      const s = loadSettings();
      state.playerName = s.playerName ?? "Guest";
      $("uiPlayerName").textContent = state.playerName;
      $("profileName").textContent = state.playerName;

      renderBestPanel();
      resetRun();

      try{
        await loadTexts();
      }catch(e){
        console.error(e);
        toast("å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼ˆassets/texts_ja.jsonï¼‰");
      }

      await ensureAuth();
      toast("æº–å‚™OKï¼šã‚¹ã‚¿ãƒ¼ãƒˆã§ãã¾ã™");
    })();
  </script>
</body>
</html>
